---
- name: Create user groups with the correct gid.
  when: item.value.state is defined and item.value.state == "present"
  group:
    state: "{{ item.value.state }}"
    name: "{{ item.value.username }}"
    gid: "{{ item.value.uid }}"
  with_dict: "{{ aspects_local_users }}"
  tags:
    - aspects_local_users
    - aspects_local_users_groups

- name: Create users.
  when: item.value.state is defined and item.value.state is defined
  user:
    state: "{{ item.value.state }}"
    name: "{{ item.value.username }}"
    comment: "{{ item.value.fullname }}"
    password: "{{ item.value.crypted_pass }}"
    createhome: "yes"
    home: "{{ item.value.home|default('/home/' + item.value.username) }}"
    shell: "{{ item.value.shell }}"
    uid: "{{ item.value.uid }}"
  with_dict: "{{ aspects_local_users }}"
  tags:
    - aspects_local_users

- name: Add/Remove extra groups by OS family.
  when: aspects_local_users_groups is defined
  include: "addRemoveExtraGroups{{ ansible_os_family }}.yml"
  tags:
    - aspects_local_users
    - aspects_local_users_groups

- name: Set users extra groups by OS family.
  include: "setExtraGroups{{ ansible_os_family }}.yml"
  tags:
    - aspects_local_users
    - aspects_local_users_groups

- name: ensure user ssh keys are set
  when: aspects_local_users_ssh_keys is defined and item.value.state is defined
  authorized_key:
    state: "{{ item.value.state }}"
    user: "{{ item.value.username }}"
    key: "{{ item.value.key }}"
  with_dict: "{{ aspects_local_users_ssh_keys }}"
  tags:
    - aspects_local_users
    - aspects_local_users_ssh_keys
