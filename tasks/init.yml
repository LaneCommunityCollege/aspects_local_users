---
- name: Create user groups with the correct gid.
  when: item.value.state is defined and item.value.state == "present"
  group:
    state: "{{ item.value.state }}"
    name: "{{ item.value.username }}"
    gid: "{{ item.value.uid }}"
  loop: "{{ aspects_local_users | default({}) | dict2items }}"
  tags:
    - aspects_local_users
    - aspects_local_users_groups

- name: Set user state
  when: item.value.state is defined
  user:
    state: "{{ item.value.state }}"
    name: "{{ item.value.username }}"
    comment: "{{ item.value.fullname }}"
    password: "{{ item.value.crypted_pass }}"
    createhome: "yes"
    home: "{{ item.value.home|default('/home/' + item.value.username) }}"
    shell: "{{ item.value.shell }}"
    uid: "{{ item.value.uid }}"
    group: "{{ item.value.username }}"
  loop: "{{ aspects_local_users | default({}) | dict2items }}"
  tags:
    - aspects_local_users

- name: Debian - Add/Remove extra groups by OS family.
  when:
    - aspects_local_users_groups is defined
    - ansible_distribution == "Debian" or ansible_distribution == "Pop!_OS" or ansible_distribution == "Ubuntu"
  include_tasks: "addRemoveExtraGroupsDebian.yml"
  tags:
    - aspects_local_users
    - aspects_local_users_groups

- name: RedHat - Add/Remove extra groups by OS family.
  when:
    - aspects_local_users_groups is defined
    - ansible_distribution == "RedHat" or ansible_distribution == "OracleLinux"
  include_tasks: "addRemoveExtraGroupsRedHat.yml"
  tags:
    - aspects_local_users
    - aspects_local_users_groups

- name: Set system group state
  when: aspects_local_users_system_groups is defined
  group:
    state: "{{ item.value.state }}"
    name: "{{ item.value.name }}"
    gid: "{{ item.value.gid }}"
    system: "yes"
  loop: "{{ aspects_local_users_system_groups|default({})|dict2items }}"
  tags:
    - aspects_local_users

- name: Set system user group state
  when: aspects_local_users_system_groups is defined
  group:
    state: "{{ item.value.state }}"
    name: "{{ item.value.username }}"
    gid: "{{ item.value.uid }}"
    system: "yes"
  loop: "{{ aspects_local_users_system_users|default({})|dict2items }}"
  tags:
    - aspects_local_users

- name: Set system user state
  when: aspects_local_users_system_users is defined
  user:
    state: "{{ item.value.state }}"
    name: "{{ item.value.username }}"
    comment: "{{ item.value.fullname }}"
    password: "{{ item.value.crypted_pass }}"
    createhome: "yes"
    home: "{{ item.value.home|default('/home/' + item.value.username) }}"
    shell: "{{ item.value.shell }}"
    uid: "{{ item.value.uid }}"
    group: "{{ item.value.group|default(item.value.username) }}"
    system: "yes"
  loop: "{{ aspects_local_users_system_users|default({})|dict2items }}"
  tags:
    - aspects_local_users

- name: Add/Remove extra groups by OS family.
  when:
    - aspects_local_users_groups is defined
    - ansible_distribution == "Debian" or ansible_distribution == "Pop!_OS" or ansible_distribution == "Ubuntu"
  include_tasks: "addRemoveExtraGroupsDebian.yml"
  tags:
    - aspects_local_users
    - aspects_local_users_groups

- name: Add/Remove extra groups by OS family.
  when:
    - aspects_local_users_groups is defined
    - ansible_distribution == "RedHat" or ansible_distribution == "OracleLinux"
  include_tasks: "addRemoveExtraGroupsRedHat.yml"
  tags:
    - aspects_local_users
    - aspects_local_users_groups

- name: Debian - Set users extra groups by OS family.
  when:
    - ansible_distribution == "Debian" or ansible_distribution == "Pop!_OS" or ansible_distribution == "Ubuntu"
  include_tasks: "setExtraGroupsDebian.yml"
  tags:
    - aspects_local_users
    - aspects_local_users_groups

- name: RedHat - Set users extra groups by OS family.
  when:
    - ansible_distribution == "RedHat" or ansible_distribution == "OracleLinux"
  include_tasks: "setExtraGroupsRedHat.yml"
  tags:
    - aspects_local_users
    - aspects_local_users_groups

- name: ensure user ssh keys are set
  when: aspects_local_users_ssh_keys is defined and item.value.state is defined
  authorized_key:
    state: "{{ item.value.state }}"
    user: "{{ item.value.username }}"
    key: "{{ item.value.ssh_pubkey }}"
  loop: "{{ aspects_local_users_ssh_keys | default({}) | dict2items }}"
  tags:
    - aspects_local_users
    - aspects_local_users_ssh_keys
