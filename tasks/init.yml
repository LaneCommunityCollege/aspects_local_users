---
# tasks file for aspects_local_users

- name: ensure users exist.
  when: item.value.state is defined
  user:
    state: "{{ item.value.state }}"
    name: "{{ item.value.username }}"
    comment: "{{ item.value.fullname }}"
    password: "{{ item.value.crypted_pass }}"
    createhome: "yes"
    home: "{{ item.value.home|default('/home/' + item.value.username) }}"
    shell: "{{ item.value.shell }}"
    uid: "{{ item.value.uid }}"
  with_dict: "{{ aspects_local_users }}"
  tags:
    - aspects_local_users

- name: ensure user groups exist and have the correct gid.
  when: item.value.state == "present"
  group:
    state: "{{ item.value.state }}"
    name: "{{ item.value.username }}"
    gid: "{{ item.value.uid }}"
  with_dict: "{{ aspects_local_users }}"
  tags:
    - aspects_local_users

- name: Set extra groups by OS family.
  include: "setExtraGroups{{ ansible_os_family }}.yml"
  tags:
    - aspects_local_users

- name: Set ssh authorized_key's in user's .ssh/authorized_keys file.
  include: setSshAuthorizedKeys.yml
  tags:
    - aspects_local_users
    - aspects_local_users_ssh_keys
